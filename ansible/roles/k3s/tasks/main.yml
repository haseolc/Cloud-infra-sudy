---
# 1) K3s 설치 실행
- name: "K3s 설치 실행 (SELinux 설치 건너뛰기 및 Traefik 비활성화)"
  become: yes
  ansible.builtin.shell: |
    curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--disable traefik" INSTALL_K3S_SKIP_SELINUX_RPM=true sh -
  args:
    executable: /bin/bash
    creates: /usr/local/bin/k3s
  register: k3s_install_output

# 2) 설치 로그 확인 (디버깅용)
- name: "K3s 설치 결과 출력"
  ansible.builtin.debug:
    var: k3s_install_output.stdout_lines

# 3) kubeconfig 생성될 때까지 대기
- name: "k3s.yaml 설정 파일 생성 확인 (최대 2분)"
  become: yes
  ansible.builtin.wait_for:
    path: /etc/rancher/k3s/k3s.yaml
    state: present
    timeout: 120

# 4) ec2-user kubeconfig 디렉토리 생성
- name: "ec2-user용 kubeconfig 디렉토리 생성"
  become: yes
  ansible.builtin.file:
    path: /home/ec2-user/.kube
    state: directory
    owner: ec2-user
    group: ec2-user
    mode: '0755'

# 5) kubeconfig 파일 복사 및 권한 설정
- name: "kubeconfig 파일 복사 및 권한 부여"
  become: yes
  ansible.builtin.shell: |
    cp /etc/rancher/k3s/k3s.yaml /home/ec2-user/.kube/config
    chown ec2-user:ec2-user /home/ec2-user/.kube/config
    chmod 600 /home/ec2-user/.kube/config
  args:
    executable: /bin/bash

# 6) ec2-user의 .bashrc에 KUBECONFIG 설정 추가
- name: "ec2-user의 .bashrc에 KUBECONFIG 경로 추가"
  become: yes
  ansible.builtin.lineinfile:
    path: /home/ec2-user/.bashrc
    line: 'export KUBECONFIG=$HOME/.kube/config'
    state: present
